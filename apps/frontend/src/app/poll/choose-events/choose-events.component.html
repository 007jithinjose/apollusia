<div class="container">
  @if (!mail) {
    <app-mail-alert></app-mail-alert>
  }
  <h1 class="text-center">
    {{ poll?.title }}
  </h1>
  <div class="mb-3">
    @if (poll?.location; as location) {
      <div class="d-flex align-items-center">
        <i class="text-primary fs-4 me-2 {{location | locationIcon}}" ngbTooltip="Location"></i>
        <app-location-link [location]="location"></app-location-link>
      </div>
    }
    @if (poll?.settings?.deadline; as deadline) {
      <div class="d-flex align-items-center">
        <i class="bi-calendar text-primary fs-4 me-2" ngbTooltip="Deadline"></i>
        {{ deadline | date: 'medium' }}
      </div>
    }
    @if (poll?.description; as description) {
      <div class="d-flex align-items-center">
        <i class="bi-file-text text-primary fs-4 me-2" ngbTooltip="Description"></i>
        <app-markdown [text]="description"></app-markdown>
      </div>
    }
    <div class="d-flex align-items-center">
      <i class="bi-link text-primary fs-4 me-2" ngbTooltip="Link"></i>
      <a routerLink="." class="text-truncate">{{ url }}</a>
      <button class="btn btn-link bi-clipboard" ngbTooltip="Copy to clipboard" (click)="copyToClipboard()"></button>
    </div>
  </div>
  @if (closedReason) {
    <div class="alert alert-info">
      {{ closedReason }}
    </div>
  }
  @if (poll?.settings?.blindParticipation && !showResults) {
    <div class="alert alert-info">
      This is a blind poll. You can't see results or other user's votes until you participate yourself.
    </div>
  }
  @if (!closedReason && poll?.settings?.maxParticipantEvents; as limit) {
    <div class="alert alert-info mb-0">
      This poll is limited.
      You can select up to {{ limit }} choices.
    </div>
  }
  @if (pollEvents) {
    <div class="table-responsive text-center">
      <table class="table align-middle">
        <thead>
        <tr>
          <th scope="col"></th>
          @for (event of pollEvents; track event) {
            <th scope="col">
              <app-event-head
                [event]="event"
                [class.text-muted]="isPastEvent(event)"
              ></app-event-head>
            </th>
          }
          <th class="border-0" scope="col"></th>
        </tr>
        </thead>
        <tbody>
          @if (!closedReason) {
            <tr>
              <th style="min-width: 240px" scope="row">
                <input
                  class="form-control"
                  type="text"
                  id="name"
                  placeholder="Your name"
                  [disabled]="poll?.settings?.anonymous ?? false"
                  [(ngModel)]="newParticipant.name" (change)="validateNew()"
                >
              </th>
              @for (event of pollEvents; track event) {
                <td>
                  <app-check-button
                    [poll]="poll"
                    [(check)]="newParticipant.selection[event._id]"
                    (checkChange)="validateNew()"
                    [isFull]="maxParticipantsReached(event)"
                    [isPastEvent]="isPastEvent(event)"
                  ></app-check-button>
                </td>
              }
              <th class="border-0 text-start" scope="col">
                <div class="d-inline-block" [ngbTooltip]="errors.length ? errors.join(',\n') : null">
                  <button class="btn btn-primary btn-sm" [disabled]="errors.length" (click)="submit()">
                    Submit
                  </button>
                </div>
              </th>
            </tr>
          }
          @if (showResults) {
            @for (participant of participants; track participant) {
              <tr>
                <th>
                  {{ poll?.settings?.anonymous ? 'Anonymous' : participant.name }}
                  @if (participant.createdAt) {
                    <span class="small text-muted" [ngbTooltip]="participant.createdAt | date:'medium'">
                      {{ participant.createdAt | date: 'shortTime' }}
                    </span>
                  }
                  @if (participant.updatedAt !== participant.createdAt) {
                    <span class="small text-muted" [ngbTooltip]="participant.updatedAt | date:'medium'">
                      &bull; edited
                    </span>
                  }
                </th>
                @if (participant !== editParticipant) {
                  @for (pollEvent of pollEvents; track pollEvent; let n = $index) {
                    <td>
                      @switch (participant.selection[pollEvent._id]) {
                        @case ('yes') {
                          <h5 class="p-yes bi-check-lg" ngbTooltip="Yes"></h5>
                        }
                        @case ('no') {
                          <h5 class="p-no bi-x-lg" ngbTooltip="No"></h5>
                        }
                        @case ('maybe') {
                          <h5 class="p-maybe bi-question" ngbTooltip="Maybe"></h5>
                        }
                        @default {
                          <h5 class="p-unset bi-question" ngbTooltip="Unspecified"></h5>
                        }
                      }
                    </td>
                  }
                }
                @if (participant === editParticipant && editDto) {
                  @for (event of pollEvents; track event) {
                    <td>
                      <app-check-button
                        [poll]="poll"
                        [(check)]="editDto.selection[event._id]"
                        (checkChange)="validateEdit()"
                        [isPastEvent]="isPastEvent(event)"
                      ></app-check-button>
                    </td>
                  }
                }
                @if (participant === editParticipant) {
                  <td class="border-0 text-start">
                    <button class="btn btn-primary btn-sm ms-1 bi-x" type="button" (click)="cancelEdit()"></button>
                    <div class="d-inline-block" [ngbTooltip]="errors.length ? errors.join(',\n') : null">
                      <button class="btn btn-secondary btn-sm ms-1 bi-check" type="button" [disabled]="errors.length"
                              (click)="confirmEdit()"></button>
                    </div>
                  </td>
                }
                @if (!editParticipant) {
                  <td class="border-0 text-start">
                    @if (poll?.settings?.allowEdit && token === participant.token) {
                      <button
                        class="btn btn-primary btn-sm ms-1 bi-pencil"
                        placement="top"
                        ngbTooltip="Edit participation"
                        (click)="setEditParticipant(participant)">
                      </button>
                    }
                    @if (isAdmin || token === participant.token) {
                      <button
                        class="btn btn-sm btn-danger ms-1 bi-trash"
                        type="button"
                        placement="top"
                        ngbTooltip="Delete participation"
                        (click)="deleteParticipation(participant._id)">
                      </button>
                    }
                  </td>
                }
              </tr>
            }
            <tr>
              <th>Sum</th>
              @for (pollEvent of pollEvents; track pollEvent) {
                <td>
                  @if (bestOption === countParticipants(pollEvent)) {
                    <h5 class="bi-award text-primary">
                      {{ countParticipants(pollEvent) }}
                    </h5>
                  }
                  @if (bestOption !== countParticipants(pollEvent)) {
                    <div>
                      {{ countParticipants(pollEvent) }}
                    </div>
                  }
                </td>
              }
              <td class="border-0"></td>
            </tr>
          }
          @if (poll && isAdmin) {
            <tr>
              <th>Select Events</th>
              @for (pollEvent of pollEvents; track pollEvent; let i = $index) {
                <td>
                  <input
                    type="checkbox"
                    class="text-primary form-check-hidden"
                    [class.bi-star-fill]="bookedEvents[i]"
                    [class.bi-star]="!bookedEvents[i]"
                    [(ngModel)]="bookedEvents[i]"
                  >
                </td>
              }
              <td class="border-0 text-start">
                <button
                  class="btn btn-sm btn-primary"
                  type="button"
                  (click)="book()">
                  Book
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>
