<div class="container">
  <div *ngIf="!mail" class="alert alert-warning">
    You seem to have no mail configured.
    <a class="bi-gear" [routerLink]="[{outlets: {modal: 'settings'}}]">
      Configure
    </a>
  </div>
  <h1 class="text-center">
    {{poll?.title}}
  </h1>
  <div class="mb-3">
    <div *ngIf="poll?.location as location" class="d-flex align-items-center">
      <i class="bi-geo text-primary fs-4 me-2" ngbTooltip="Location"></i>
      {{ location }}
    </div>
    <div *ngIf="poll?.settings?.deadline as deadline" class="d-flex align-items-center">
      <i class="bi-calendar text-primary fs-4 me-2" ngbTooltip="Deadline"></i>
      {{ deadline | date: 'medium' }}
    </div>
    <div *ngIf="poll?.description as description" class="d-flex align-items-center">
      <i class="bi-file-text text-primary fs-4 me-2" ngbTooltip="Description"></i>
      <div style="white-space: pre-line">
        {{ description }}
      </div>
    </div>
    <div class="d-flex align-items-center">
      <i class="bi-link text-primary fs-4 me-2" ngbTooltip="Link"></i>
      <a [href]="url" class="text-truncate">{{ url }}</a>
      <button class="btn btn-link bi-clipboard" ngbTooltip="Copy to clipboard" (click)="copyToClipboard()"></button>
    </div>
  </div>
  <div *ngIf="pollEvents" class="table-responsive text-center">
    <form [formGroup]="participateForm" (ngSubmit)="onFormSubmit()">
      <table class="table align-middle">
        <thead>
        <tr>
          <th scope="col"></th>
          <th *ngFor="let event of pollEvents" scope="col">
            <app-event-head [event]="event"></app-event-head>
          </th>
          <th class="border-0" scope="col"></th>
        </tr>
        </thead>
        <tbody>
        <tr *ngIf="!isFull(); else fullAlert">
          <th style="min-width: 240px" scope="row">
            <input *ngIf="!poll?.settings?.anonymous"
                   class="form-control"
                   type="text"
                   id="name"
                   placeholder="Your name"
                   formControlName="name">
            <input *ngIf="poll?.settings?.anonymous"
                   class="form-control"
                   type="text"
                   value="Anonymous"
                   [disabled]="true">
          </th>
          <td *ngFor="let event of pollEvents; let n=index">
            <app-check-button
              [poll]="poll"
              [check]="checks[n]"
              [isFull]="maxParticipantsReached(event)"
              (checkChanged)="checks[n] = $event"
            ></app-check-button>
          </td>
          <th class="border-0 text-start" scope="col">
            <button class="btn btn-primary btn-sm" type="submit" [disabled]="!participateForm.valid">Submit</button>
          </th>
        </tr>
        <ng-template #fullAlert>
          <tr>
            <td [colSpan]="2 + pollEvents.length">
              <div class="alert alert-info">
                This poll has reached it's maximum number of participants.
                You can no longer submit your vote.
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-container *ngIf="!poll?.settings?.blindParticipation || isAdmin || userVoted(); else blindAlert">
          <tr *ngFor="let participant of participants">
            <th>
              <div *ngIf="poll?.settings?.anonymous">
                Anonymous
              </div>
              <div *ngIf="!poll?.settings?.anonymous">
                {{participant.name}}
              </div>
            </th>
            <ng-container *ngIf="participant !== editParticipant">
              <td *ngFor="let pollEvent of pollEvents; let n=index">
                <div *ngIf="(participant.participation | some: pollEvent._id ) && participant !== editParticipant"
                     class="p-check">
                  <i class="bi-check-lg icon"></i>
                </div>
                <div *ngIf="!(participant.participation | some: pollEvent._id )
                && !(participant.indeterminateParticipation | some: pollEvent._id ) && participant !== editParticipant"
                     class="p-unchecked">
                  <i class="bi-x-lg icon"></i>
                </div>
                <div
                  *ngIf="(participant.indeterminateParticipation | some: pollEvent._id ) && participant !== editParticipant"
                  class="p-indeterminate">
                  <i class="bi-question icon"></i>
                </div>
              </td>
            </ng-container>
            <ng-container *ngIf="participant === editParticipant">
              <td *ngFor="let check of editChecks; let n=index">
                <app-check-button [poll]="poll" [check]="check" (checkChanged)="editChecks[n] = $event"></app-check-button>
              </td>
            </ng-container>
            <td *ngIf="participant === editParticipant" class="border-0 text-start">
              <button class="btn btn-primary btn-sm ms-1" type="button" (click)="cancelEdit()">
                <i class="bi-x"></i>
              </button>
              <button class="btn btn-secondary btn-sm ms-1" type="button" (click)="confirmEdit()">
                <i class="bi-check"></i>
              </button>
            </td>
            <td *ngIf="!editParticipant" class="border-0 text-start">
              <button
                *ngIf="poll?.settings?.allowEdit && getToken() === participant.token"
                class="btn btn-primary btn-sm ms-1"
                placement="top"
                ngbTooltip="Edit participation"
                (click)="setEditParticipant(participant)">
                <i class="bi-pencil"></i>
              </button>
              <button
                *ngIf="isAdmin || getToken() === participant.token"
                class="btn btn-sm btn-danger ms-1"
                type="button"
                placement="top"
                ngbTooltip="Delete participation"
                (click)="deleteParticipation(participant._id)"
              >
                <i class="bi-trash"></i>
              </button>
            </td>
          </tr>
          <tr>
            <th>Sum</th>
            <td *ngFor="let pollEvent of pollEvents">
              <div *ngIf="bestOption === countParticipants(pollEvent)" class="p-unchecked">
                <i class="bi-award"></i>
                {{ countParticipants(pollEvent) }}
              </div>
              <div *ngIf="bestOption !== countParticipants(pollEvent)">
                {{ countParticipants(pollEvent) }}
              </div>
            </td>
            <td class="border-0"></td>
          </tr>
        </ng-container>
        <ng-template #blindAlert>
          <tr>
            <td [colSpan]="2 + pollEvents.length">
              <div class="alert alert-info">
                This is a blind poll. You can't see results or other user's votes until you participate yourself.
              </div>
            </td>
          </tr>
        </ng-template>
        <tr *ngIf="isAdmin">
          <th>Select Events</th>
          <td *ngFor="let pollEvent of pollEvents">
            <button
              type="button"
              class="btn text-primary"
              [class.bi-star-fill]="pollEvent._id && bookedEvents.includes(pollEvent._id)"
              [class.bi-star]="pollEvent._id && !bookedEvents.includes(pollEvent._id)"
              (click)="selectEvent(pollEvent._id)"
            ></button>
          </td>
          <td class="border-0 text-start">
            <button
              class="btn btn-sm btn-primary"
              type="button"
              [disabled]="bookedEvents.length === 0"
              (click)="book()">
              Book
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </form>
  </div>
</div>
<ngbx-toast-list></ngbx-toast-list>
